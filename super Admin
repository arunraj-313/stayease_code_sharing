using System;
using System.Data.SqlClient;
using System.Web.Mvc;
using System.Configuration;

namespace PG.Controllers
{
    public class SuperAdminController : Controller
    {
        string connString = ConfigurationManager.ConnectionStrings["EasyPG"].ConnectionString;

        // Login Page
        public ActionResult Login()
        {
            return View();
        }

        [HttpPost]
        public ActionResult Login(string Username, string Password)
        {
            using (SqlConnection con = new SqlConnection(connString))
            {
                con.Open();
                SqlCommand cmd = new SqlCommand(
                    "SELECT COUNT(*) FROM SuperAdmin WHERE Username=@U AND PasswordHash=@P", con);

                cmd.Parameters.AddWithValue("@U", Username);
                cmd.Parameters.AddWithValue("@P", Password);

                int count = (int)cmd.ExecuteScalar();

                if (count == 1)
                {
                    Session["SuperAdmin"] = Username;
                    return RedirectToAction("Dashboard");
                }
                else
                {
                    TempData["error"] = "Invalid Login!";
                    return View();
                }
            }
        }

        // Dashboard â†’ Show pending Admin requests
        public ActionResult Dashboard()
        {
            if (Session["SuperAdmin"] == null)
                return RedirectToAction("Login");

            using (SqlConnection con = new SqlConnection(connString))
            {
                con.Open();
                SqlCommand cmd = new SqlCommand(
                    "SELECT * FROM PendingAdminRequests WHERE Status='Pending'", con);

                SqlDataReader dr = cmd.ExecuteReader();
                return View(dr);
            }
        }

        // Approve Admin
        public ActionResult Approve(int id)
        {
            using (SqlConnection con = new SqlConnection(connString))
            {
                con.Open();

                // 1. Get data from pending table
                SqlCommand get = new SqlCommand(
                    "SELECT * FROM PendingAdminRequests WHERE RequestID=@id", con);
                get.Parameters.AddWithValue("@id", id);
                SqlDataReader dr = get.ExecuteReader();

                if (!dr.Read()) return RedirectToAction("Dashboard");

                string fullName = dr["FullName"].ToString();
                string email = dr["Email"].ToString();
                string phone = dr["PhoneNo"].ToString();
                string pass = dr["PasswordHash"].ToString();

                dr.Close();

                // 2. Insert Into Admins table
                SqlCommand ins = new SqlCommand(@"
                    INSERT INTO Admins (FullName, Email, PhoneNo, PasswordHash, Role)
                    VALUES (@F,@E,@P,@PW,'Admin')", con);

                ins.Parameters.AddWithValue("@F", fullName);
                ins.Parameters.AddWithValue("@E", email);
                ins.Parameters.AddWithValue("@P", phone);
                ins.Parameters.AddWithValue("@PW", pass);
                ins.ExecuteNonQuery();

                // 3. Delete from pending table
                SqlCommand del = new SqlCommand(
                    "DELETE FROM PendingAdminRequests WHERE RequestID=@id", con);
                del.Parameters.AddWithValue("@id", id);
                del.ExecuteNonQuery();
            }

            return RedirectToAction("Dashboard");
        }

        // Decline
        public ActionResult Decline(int id)
        {
            using (SqlConnection con = new SqlConnection(connString))
            {
                con.Open();
                SqlCommand del = new SqlCommand(
                    "DELETE FROM PendingAdminRequests WHERE RequestID=@id", con);
                del.Parameters.AddWithValue("@id", id);
                del.ExecuteNonQuery();
            }

            return RedirectToAction("Dashboard");
        }
    }
}









@{
    ViewBag.Title = "Pending Admin Requests";
}

<h2>Pending Admin Approvals</h2>

<table class="table">
    <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Phone</th>
        <th>Action</th>
    </tr>

@foreach (System.Data.Common.DbDataRecord row in Model)
{
    <tr>
        <td>@row["FullName"]</td>
        <td>@row["Email"]</td>
        <td>@row["PhoneNo"]</td>
        <td>
            <a class="btn btn-success" href="/SuperAdmin/Approve/@row["RequestID"]">Approve</a>
            <a class="btn btn-danger" href="/SuperAdmin/Decline/@row["RequestID"]">Decline</a>
        </td>
    </tr>
}
</table>







[HttpPost]
public ActionResult Login(string Email, string Password)
{
    using (SqlConnection con = new SqlConnection(connString))
    {
        con.Open();

        // 1) SuperAdmin Check
        SqlCommand cmdSuper = new SqlCommand(
            "SELECT COUNT(*) FROM SuperAdmin WHERE LOWER(Username)=@Email AND PasswordHash=@Password", con);

        cmdSuper.Parameters.AddWithValue("@Email", Email.ToLower());
        cmdSuper.Parameters.AddWithValue("@Password", Password);

        int super = (int)cmdSuper.ExecuteScalar();
        if (super == 1)
        {
            Session["SuperAdmin"] = Email;
            return RedirectToAction("Dashboard", "SuperAdmin");
        }

        // 2) Admin Check
        SqlCommand cmdAdmin = new SqlCommand(
            "SELECT COUNT(*) FROM Admins WHERE LOWER(Email)=@Email AND PasswordHash=@Password", con);

        cmdAdmin.Parameters.AddWithValue("@Email", Email.ToLower());
        cmdAdmin.Parameters.AddWithValue("@Password", Password);

        int admin = (int)cmdAdmin.ExecuteScalar();
        if (admin == 1)
        {
            Session["Admin"] = Email;
            return RedirectToAction("Dashboard", "Admin");
        }

        // 3) User Check
        SqlCommand cmdUser = new SqlCommand(
            "SELECT COUNT(*) FROM Users WHERE LOWER(Email)=@Email AND PasswordHash=@Password", con);

        cmdUser.Parameters.AddWithValue("@Email", Email.ToLower());
        cmdUser.Parameters.AddWithValue("@Password", Password);

        int user = (int)cmdUser.ExecuteScalar();
        if (user == 1)
        {
            Session["User"] = Email;
            return RedirectToAction("Index", "UserPG");
        }

        TempData["error"] = "Invalid email or password!";
        return RedirectToAction("Index", "Home", new { openLogin = "true" });
    }
}






if (isAdmin)
{
    // Insert into PendingAdminRequests instead of Admins
    string query = @"
        INSERT INTO PendingAdminRequests 
            (FullName, Email, PhoneNo, PasswordHash)
        VALUES 
            (@FullName, @Email, @PhoneNo, @PasswordHash)";

    using (SqlCommand cmd = new SqlCommand(query, con))
    {
        cmd.Parameters.Add("@FullName", SqlDbType.NVarChar).Value = user.FullName ?? "";
        cmd.Parameters.Add("@Email", SqlDbType.NVarChar).Value = email;
        cmd.Parameters.Add("@PhoneNo", SqlDbType.NVarChar).Value = user.PhoneNo ?? "";
        cmd.Parameters.Add("@PasswordHash", SqlDbType.NVarChar).Value = user.Password ?? "";
        cmd.ExecuteNonQuery();
    }

    TempData["success"] = "Admin request submitted! Awaiting approval.";
}
