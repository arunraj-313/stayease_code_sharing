using System;
using System.Data;
using System.Data.SqlClient;
using System.Configuration;
using System.Net.Mail;
using System.Net;
using System.Web.Mvc;

namespace StayEasePG.Controllers
{
    public class SuperAdminController : Controller
    {
        string connString = ConfigurationManager.ConnectionStrings["StayEasePGConn"].ConnectionString;

        // ===================== DASHBOARD ======================
        public ActionResult Dashboard()
        {
            // Check if logged in
            if (Session["SuperAdmin"] == null)
                return RedirectToAction("Index", "Home", new { openLogin = "true" });

            DataTable dt = new DataTable();

            using (SqlConnection con = new SqlConnection(connString))
            {
                string q = "SELECT * FROM PendingAdminRequests WHERE Status='Pending'";
                using (SqlDataAdapter da = new SqlDataAdapter(q, con))
                {
                    da.Fill(dt);
                }
            }

            return View(dt);
        }

        // ===================== APPROVE ======================
        public ActionResult Approve(int id)
        {
            using (SqlConnection con = new SqlConnection(connString))
            {
                con.Open();

                // Read pending data
                string get = "SELECT * FROM PendingAdminRequests WHERE RequestID=@id";
                SqlCommand cmdGet = new SqlCommand(get, con);
                cmdGet.Parameters.AddWithValue("@id", id);

                SqlDataReader dr = cmdGet.ExecuteReader();
                if (!dr.Read())
                {
                    TempData["error"] = "Request not found!";
                    return RedirectToAction("Dashboard");
                }

                string fullName = dr["FullName"].ToString();
                string email = dr["Email"].ToString();
                string phone = dr["PhoneNo"].ToString();
                string password = dr["PasswordHash"].ToString();
                dr.Close();

                // Insert into Admins table
                string insert = @"INSERT INTO Admins (FullName, Email, PhoneNo, PasswordHash, Role)
                                  VALUES (@F,@E,@P,@PW,'Admin')";

                SqlCommand cmdInsert = new SqlCommand(insert, con);
                cmdInsert.Parameters.AddWithValue("@F", fullName);
                cmdInsert.Parameters.AddWithValue("@E", email.ToLower());
                cmdInsert.Parameters.AddWithValue("@P", phone);
                cmdInsert.Parameters.AddWithValue("@PW", password);
                cmdInsert.ExecuteNonQuery();

                // Update pending table
                SqlCommand cmdUpdate = new SqlCommand(
                    "UPDATE PendingAdminRequests SET Status='Approved' WHERE RequestID=@id", con);
                cmdUpdate.Parameters.AddWithValue("@id", id);
                cmdUpdate.ExecuteNonQuery();

                // SEND EMAIL
                SendApprovalEmail(email, fullName);
            }

            TempData["success"] = "Admin Approved Successfully!";
            return RedirectToAction("Dashboard");
        }

        // ===================== DECLINE ======================
        public ActionResult Decline(int id)
        {
            using (SqlConnection con = new SqlConnection(connString))
            {
                con.Open();

                SqlCommand cmd = new SqlCommand(
                    "DELETE FROM PendingAdminRequests WHERE RequestID=@id", con);
                cmd.Parameters.AddWithValue("@id", id);
                cmd.ExecuteNonQuery();
            }

            TempData["success"] = "Admin Request Declined!";
            return RedirectToAction("Dashboard");
        }

        // ===================== SEND APPROVAL EMAIL ======================
        private void SendApprovalEmail(string email, string fullName)
        {
            try
            {
                MailMessage mail = new MailMessage();
                mail.To.Add(email);
                mail.From = new MailAddress("stayeasepgbooking@gmail.com");
                mail.Subject = "StayEase Admin Approval";
                mail.Body = $"Hello {fullName},\n\n" +
                            "Your admin account has been approved! üéâ\n" +
                            "You can now login to StayEase as an Admin.\n\n" +
                            "Thank you,\nStayEase Team";

                SmtpClient smtp = new SmtpClient("smtp.gmail.com", 587);
                smtp.EnableSsl = true;
                smtp.Credentials = new NetworkCredential("stayeasepgbooking@gmail.com", "fstz tzcr yxbj bkbx");

                smtp.Send(mail);
            }
            catch
            {
                // ignore
            }
        }
    }
}








@model System.Data.DataTable
@{
    ViewBag.Title = "Super Admin Dashboard";
}

<h2 class="text-center mt-3">Pending Admin Approvals</h2>

@if (TempData["success"] != null)
{
    <div class="alert alert-success">@TempData["success"]</div>
}
@if (TempData["error"] != null)
{
    <div class="alert alert-danger">@TempData["error"]</div>
}

<table class="table table-bordered table-striped mt-4">
    <thead>
        <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Phone No</th>
            <th>Request Date</th>
            <th>Action</th>
        </tr>
    </thead>

    <tbody>
        @foreach (System.Data.DataRow row in Model.Rows)
        {
            <tr>
                <td>@row["FullName"]</td>
                <td>@row["Email"]</td>
                <td>@row["PhoneNo"]</td>
                <td>@row["CreatedOn"]</td>
                <td>
                    <a href="/SuperAdmin/Approve/@row["RequestID"]" class="btn btn-success btn-sm">Approve</a>
                    <a href="/SuperAdmin/Decline/@row["RequestID"]" class="btn btn-danger btn-sm">Decline</a>
                </td>
            </tr>
        }
    </tbody>
</table>












public ActionResult CompleteRegister(string Email)
{
    var user = TempData["UserData"] as UserModel;
    var role = (TempData["Role"] as string ?? "").Trim();

    if (user == null || string.IsNullOrWhiteSpace(role))
    {
        TempData["error"] = "Session expired. Please register again.";
        return RedirectToAction("Register");
    }

    string email = user.Email.Trim().ToLower();
    bool isAdmin = role.Equals("Admin", StringComparison.OrdinalIgnoreCase);

    try
    {
        using (SqlConnection con = new SqlConnection(connString))
        {
            con.Open();

            if (isAdmin)
            {
                // Insert in pending admin requests
                string q = @"INSERT INTO PendingAdminRequests 
                             (FullName, Email, PhoneNo, PasswordHash) 
                             VALUES (@F,@E,@P,@PW)";
                using (SqlCommand cmd = new SqlCommand(q, con))
                {
                    cmd.Parameters.AddWithValue("@F", user.FullName);
                    cmd.Parameters.AddWithValue("@E", email);
                    cmd.Parameters.AddWithValue("@P", user.PhoneNo);
                    cmd.Parameters.AddWithValue("@PW", user.Password);
                    cmd.ExecuteNonQuery();
                }

                TempData["success"] = "Admin request submitted! Wait for approval.";
            }
            else
            {
                // Insert User
                string q = @"INSERT INTO Users
                (FullName, Email, Gender, PhoneNo, Address, IDProofType, IDProofNumber,
                 Occupation, PasswordHash, Role)
                VALUES
                (@FullName,@Email,@Gender,@PhoneNo,@Address,@IDProofType,@IDProofNumber,
                 @Occupation,@PasswordHash,@Role)";
                
                using (SqlCommand cmd = new SqlCommand(q, con))
                {
                    cmd.Parameters.AddWithValue("@FullName", user.FullName);
                    cmd.Parameters.AddWithValue("@Email", email);
                    cmd.Parameters.AddWithValue("@Gender", user.Gender);
                    cmd.Parameters.AddWithValue("@PhoneNo", user.PhoneNo);
                    cmd.Parameters.AddWithValue("@Address", user.Address);
                    cmd.Parameters.AddWithValue("@IDProofType", user.IDProofType);
                    cmd.Parameters.AddWithValue("@IDProofNumber", user.IDProofNumber);
                    cmd.Parameters.AddWithValue("@Occupation", user.Occupation);
                    cmd.Parameters.AddWithValue("@PasswordHash", user.Password);
                    cmd.Parameters.AddWithValue("@Role", role);
                    cmd.ExecuteNonQuery();
                }

                // ‚≠ê SEND WELCOME EMAIL FOR USER NOW
                SendWelcomeEmail(email, user.FullName);
            }
        }

        Session.Clear();

        TempData["success"] = "Account created successfully!";
        TempData["OpenLoginPopup"] = "true";

        return RedirectToAction("Index", "Home", new { openLogin = "true" });
    }
    catch
    {
        TempData["error"] = "Something went wrong!";
        return RedirectToAction("Register");
    }
}










public ActionResult Approve(int id)
{
    using (SqlConnection con = new SqlConnection(connString))
    {
        con.Open();

        // Load pending admin
        string selectQ = "SELECT * FROM PendingAdminRequests WHERE RequestID=@ID";
        SqlCommand selectCmd = new SqlCommand(selectQ, con);
        selectCmd.Parameters.AddWithValue("@ID", id);
        SqlDataReader dr = selectCmd.ExecuteReader();

        if (!dr.Read())
        {
            TempData["error"] = "Request not found!";
            return RedirectToAction("PendingAdmins");
        }

        string fullName = dr["FullName"].ToString();
        string email = dr["Email"].ToString();
        string phone = dr["PhoneNo"].ToString();
        string password = dr["PasswordHash"].ToString();
        dr.Close();

        // Insert into Admins
        string insertQ = @"INSERT INTO Admins
                          (FullName, Email, PhoneNo, PasswordHash, Role)
                           VALUES (@F,@E,@P,@PW,'Admin')";
        SqlCommand insertCmd = new SqlCommand(insertQ, con);
        insertCmd.Parameters.AddWithValue("@F", fullName);
        insertCmd.Parameters.AddWithValue("@E", email);
        insertCmd.Parameters.AddWithValue("@P", phone);
        insertCmd.Parameters.AddWithValue("@PW", password);
        insertCmd.ExecuteNonQuery();

        // Delete pending request
        SqlCommand deleteCmd = new SqlCommand("DELETE FROM PendingAdminRequests WHERE RequestID=@ID", con);
        deleteCmd.Parameters.AddWithValue("@ID", id);
        deleteCmd.ExecuteNonQuery();

        // ‚≠ê SEND WELCOME EMAIL TO APPROVED ADMIN
        SendWelcomeEmail(email, fullName);

        TempData["success"] = "Admin approved!";
    }

    return RedirectToAction("PendingAdmins");
}





