using System;
using System.Data;
using System.Data.SqlClient;
using System.Configuration;
using System.Net.Mail;
using System.Net;
using System.Web.Mvc;

namespace StayEasePG.Controllers
{
    public class SuperAdminController : Controller
    {
        string connString = ConfigurationManager.ConnectionStrings["StayEasePGConn"].ConnectionString;

        // ===================== DASHBOARD ======================
        public ActionResult Dashboard()
        {
            // Check if logged in
            if (Session["SuperAdmin"] == null)
                return RedirectToAction("Index", "Home", new { openLogin = "true" });

            DataTable dt = new DataTable();

            using (SqlConnection con = new SqlConnection(connString))
            {
                string q = "SELECT * FROM PendingAdminRequests WHERE Status='Pending'";
                using (SqlDataAdapter da = new SqlDataAdapter(q, con))
                {
                    da.Fill(dt);
                }
            }

            return View(dt);
        }

        // ===================== APPROVE ======================
        public ActionResult Approve(int id)
        {
            using (SqlConnection con = new SqlConnection(connString))
            {
                con.Open();

                // Read pending data
                string get = "SELECT * FROM PendingAdminRequests WHERE RequestID=@id";
                SqlCommand cmdGet = new SqlCommand(get, con);
                cmdGet.Parameters.AddWithValue("@id", id);

                SqlDataReader dr = cmdGet.ExecuteReader();
                if (!dr.Read())
                {
                    TempData["error"] = "Request not found!";
                    return RedirectToAction("Dashboard");
                }

                string fullName = dr["FullName"].ToString();
                string email = dr["Email"].ToString();
                string phone = dr["PhoneNo"].ToString();
                string password = dr["PasswordHash"].ToString();
                dr.Close();

                // Insert into Admins table
                string insert = @"INSERT INTO Admins (FullName, Email, PhoneNo, PasswordHash, Role)
                                  VALUES (@F,@E,@P,@PW,'Admin')";

                SqlCommand cmdInsert = new SqlCommand(insert, con);
                cmdInsert.Parameters.AddWithValue("@F", fullName);
                cmdInsert.Parameters.AddWithValue("@E", email.ToLower());
                cmdInsert.Parameters.AddWithValue("@P", phone);
                cmdInsert.Parameters.AddWithValue("@PW", password);
                cmdInsert.ExecuteNonQuery();

                // Update pending table
                SqlCommand cmdUpdate = new SqlCommand(
                    "UPDATE PendingAdminRequests SET Status='Approved' WHERE RequestID=@id", con);
                cmdUpdate.Parameters.AddWithValue("@id", id);
                cmdUpdate.ExecuteNonQuery();

                // SEND EMAIL
                SendApprovalEmail(email, fullName);
            }

            TempData["success"] = "Admin Approved Successfully!";
            return RedirectToAction("Dashboard");
        }

        // ===================== DECLINE ======================
        public ActionResult Decline(int id)
        {
            using (SqlConnection con = new SqlConnection(connString))
            {
                con.Open();

                SqlCommand cmd = new SqlCommand(
                    "DELETE FROM PendingAdminRequests WHERE RequestID=@id", con);
                cmd.Parameters.AddWithValue("@id", id);
                cmd.ExecuteNonQuery();
            }

            TempData["success"] = "Admin Request Declined!";
            return RedirectToAction("Dashboard");
        }

        // ===================== SEND APPROVAL EMAIL ======================
        private void SendApprovalEmail(string email, string fullName)
        {
            try
            {
                MailMessage mail = new MailMessage();
                mail.To.Add(email);
                mail.From = new MailAddress("stayeasepgbooking@gmail.com");
                mail.Subject = "StayEase Admin Approval";
                mail.Body = $"Hello {fullName},\n\n" +
                            "Your admin account has been approved! ðŸŽ‰\n" +
                            "You can now login to StayEase as an Admin.\n\n" +
                            "Thank you,\nStayEase Team";

                SmtpClient smtp = new SmtpClient("smtp.gmail.com", 587);
                smtp.EnableSsl = true;
                smtp.Credentials = new NetworkCredential("stayeasepgbooking@gmail.com", "fstz tzcr yxbj bkbx");

                smtp.Send(mail);
            }
            catch
            {
                // ignore
            }
        }
    }
}








@model System.Data.DataTable
@{
    ViewBag.Title = "Super Admin Dashboard";
}

<h2 class="text-center mt-3">Pending Admin Approvals</h2>

@if (TempData["success"] != null)
{
    <div class="alert alert-success">@TempData["success"]</div>
}
@if (TempData["error"] != null)
{
    <div class="alert alert-danger">@TempData["error"]</div>
}

<table class="table table-bordered table-striped mt-4">
    <thead>
        <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Phone No</th>
            <th>Request Date</th>
            <th>Action</th>
        </tr>
    </thead>

    <tbody>
        @foreach (System.Data.DataRow row in Model.Rows)
        {
            <tr>
                <td>@row["FullName"]</td>
                <td>@row["Email"]</td>
                <td>@row["PhoneNo"]</td>
                <td>@row["CreatedOn"]</td>
                <td>
                    <a href="/SuperAdmin/Approve/@row["RequestID"]" class="btn btn-success btn-sm">Approve</a>
                    <a href="/SuperAdmin/Decline/@row["RequestID"]" class="btn btn-danger btn-sm">Decline</a>
                </td>
            </tr>
        }
    </tbody>
</table>












public ActionResult CompleteRegister(string Email)
{
    var user = TempData["UserData"] as UserModel;
    var role = (TempData["Role"] as string ?? "").Trim();

    if (user == null || string.IsNullOrWhiteSpace(role))
    {
        TempData["error"] = "Session expired. Please register again.";
        return RedirectToAction("Register");
    }

    string email = user.Email.Trim().ToLower();
    bool isAdmin = role.Equals("Admin", StringComparison.OrdinalIgnoreCase);

    try
    {
        using (SqlConnection con = new SqlConnection(connString))
        {
            con.Open();

            if (isAdmin)
            {
                // Insert INTO PendingAdminRequests
                string q = @"INSERT INTO PendingAdminRequests
                            (FullName, Email, PhoneNo, PasswordHash)
                             VALUES (@F,@E,@P,@PW)";

                using (SqlCommand cmd = new SqlCommand(q, con))
                {
                    cmd.Parameters.AddWithValue("@F", user.FullName ?? "");
                    cmd.Parameters.AddWithValue("@E", email);
                    cmd.Parameters.AddWithValue("@P", user.PhoneNo ?? "");
                    cmd.Parameters.AddWithValue("@PW", user.Password ?? "");
                    cmd.ExecuteNonQuery();
                }

                TempData["success"] = "Admin request submitted! Wait for approval.";
            }
            else
            {
                // Insert INTO Users
                string q = @"INSERT INTO Users
                (FullName, Email, Gender, PhoneNo, Address, IDProofType, IDProofNumber, 
                 Occupation, PasswordHash, Role)
                VALUES (@FullName,@Email,@Gender,@PhoneNo,@Address,@IDProofType,
                @IDProofNumber,@Occupation,@PasswordHash,@Role)";

                using (SqlCommand cmd = new SqlCommand(q, con))
                {
                    cmd.Parameters.AddWithValue("@FullName", user.FullName);
                    cmd.Parameters.AddWithValue("@Email", email);
                    cmd.Parameters.AddWithValue("@Gender", user.Gender);
                    cmd.Parameters.AddWithValue("@PhoneNo", user.PhoneNo);
                    cmd.Parameters.AddWithValue("@Address", user.Address);
                    cmd.Parameters.AddWithValue("@IDProofType", user.IDProofType);
                    cmd.Parameters.AddWithValue("@IDProofNumber", user.IDProofNumber);
                    cmd.Parameters.AddWithValue("@Occupation", user.Occupation);
                    cmd.Parameters.AddWithValue("@PasswordHash", user.Password);
                    cmd.Parameters.AddWithValue("@Role", role);
                    cmd.ExecuteNonQuery();
                }

                // ðŸš« REMOVE welcome email here
            }
        }

        Session.Clear();

        return RedirectToAction("Index", "Home", new { openLogin = "true" });
    }
    catch
    {
        TempData["error"] = "Something went wrong.";
        return RedirectToAction("Register");
    }
}













[HttpPost]
public ActionResult Login(string email, string password)
{
    try
    {
        using (SqlConnection con = new SqlConnection(connString))
        {
            con.Open();

            // SUPERADMIN LOGIN
            if (email.ToLower() == "superadmin@mail.com" && password == "admin123")
            {
                Session["SuperAdmin"] = true;
                return RedirectToAction("Dashboard", "SuperAdmin");
            }

            // ADMIN LOGIN
            string adminQuery = @"SELECT AdminID, FullName, Role, Email 
                                  FROM Admins 
                                  WHERE (Email=@Email OR FullName=@Email)
                                  AND PasswordHash=@Password";

            SqlCommand adminCmd = new SqlCommand(adminQuery, con);
            adminCmd.Parameters.AddWithValue("@Email", email);
            adminCmd.Parameters.AddWithValue("@Password", password);

            SqlDataReader dr = adminCmd.ExecuteReader();

            if (dr.Read())
            {
                string adminEmail = dr["Email"].ToString();
                string adminName  = dr["FullName"].ToString();

                Session["UserID"] = dr["AdminID"].ToString();
                Session["FullName"] = adminName;
                Session["Role"] = "Admin";

                dr.Close();

                // ðŸŒŸ Send welcome email AFTER APPROVAL LOGIN (only first time)
                SendWelcomeEmail(adminEmail, adminName);

                return RedirectToAction("Dashboard", "Admin");
            }
            dr.Close();

            // USER LOGIN
            string userQuery = @"SELECT UserID, FullName, Role, Email
                                 FROM Users
                                 WHERE (Email=@Email OR FullName=@Email)
                                 AND PasswordHash=@Password";

            SqlCommand userCmd = new SqlCommand(userQuery, con);
            userCmd.Parameters.AddWithValue("@Email", email);
            userCmd.Parameters.AddWithValue("@Password", password);

            SqlDataReader dr2 = userCmd.ExecuteReader();

            if (dr2.Read())
            {
                string userEmail = dr2["Email"].ToString();
                string userName = dr2["FullName"].ToString();

                Session["UserID"] = dr2["UserID"].ToString();
                Session["FullName"] = userName;
                Session["Role"] = "User";

                dr2.Close();

                // ðŸŒŸ Send welcome email here for Users
                SendWelcomeEmail(userEmail, userName);

                return RedirectToAction("Index", "Home");
            }
            dr2.Close();

            TempData["error"] = "Invalid Login!";
            return RedirectToAction("Login");
        }
    }
    catch
    {
        TempData["error"] = "Login error!";
        return RedirectToAction("Login");
    }
}
