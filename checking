[HttpPost]
        public ActionResult Register(UserModel user, string Role)
        {
            if (!ModelState.IsValid)
            {
                TempData["error"] = "Please fill all required fields correctly!";
                return View(user);
            }

            if (user.Password != user.ConfirmPassword)
            {
                TempData["error"] = "Passwords do not match!";
                return View(user);
            }

            try
            {
                using (SqlConnection con = new SqlConnection(connString))
                {
                    string query = "";

                    if (Role.Equals("Admin", StringComparison.OrdinalIgnoreCase))
                    {
                        query = @"INSERT INTO Admins (FullName, Email, PhoneNo, PasswordHash, Role)
                          VALUES (@FullName, @Email, @PhoneNo, @PasswordHash, @Role)";
                    }
                    else
                    {
                        query = @"INSERT INTO Users (FullName, Email, Gender, PhoneNo, Address, IDProofType, IDProofNumber, Occupation, PasswordHash, Role)
                          VALUES (@FullName, @Email, @Gender, @PhoneNo, @Address, @IDProofType, @IDProofNumber, @Occupation, @PasswordHash, @Role)";
                    }
                    SqlCommand cmd = new SqlCommand(query, con);
                    cmd.Parameters.AddWithValue("@FullName", user.FullName);
                    cmd.Parameters.AddWithValue("@Email", user.Email);
                    cmd.Parameters.AddWithValue("@PhoneNo", user.PhoneNo);
                    cmd.Parameters.AddWithValue("@PasswordHash", user.Password);
                    cmd.Parameters.AddWithValue("@Role", Role);

                    // Add extra fields for Users only
                    if (Role == "User")
                    {
                        cmd.Parameters.AddWithValue("@Gender", (object)user.Gender ?? DBNull.Value);
                        cmd.Parameters.AddWithValue("@Address", user.Address ?? "");
                        cmd.Parameters.AddWithValue("@IDProofType", user.IDProofType ?? "");
                        cmd.Parameters.AddWithValue("@IDProofNumber", user.IDProofNumber ?? "");
                        cmd.Parameters.AddWithValue("@Occupation", user.Occupation ?? "");
                    }
                    con.Open();
                    cmd.ExecuteNonQuery();
                }

                TempData["success"] = "Registered Successfully!";
                return RedirectToAction("Login");
            }
            catch (Exception ex)
            {
                TempData["error"] = "Registration failed: " + ex.Message;
                return View(user);
            }
        }











using StayEasePG.Models;
using System;
using System.Collections.Generic;
using System.Configuration;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using System.Web;
using System.Net.Mail;
using System.Web.Mvc;
using System.Net;

namespace StayEasePG.Controllers
{
    public class AccountController : Controller
    {
        // DB Connection
        string connString = ConfigurationManager.ConnectionStrings["StayEasePGConn"].ConnectionString;


        // ===================== REGISTER ======================
        [HttpGet]
        public ActionResult Register()
        {
            return View();
        }

        [HttpPost]
        public ActionResult Register(UserModel user, string Role)
        {
            if (!ModelState.IsValid)
            {
                TempData["error"] = "Please fill all required fields correctly!";
                return View(user);
            }

            if (user.Password != user.ConfirmPassword)
            {
                TempData["error"] = "Passwords do not match!";
                return View(user);
            }

            try
            {
                using (SqlConnection con = new SqlConnection(connString))
                {
                    string query = "";

                    if (Role.Equals("Admin", StringComparison.OrdinalIgnoreCase))
                    {
                        query = @"INSERT INTO Admins (FullName, Email, PhoneNo, PasswordHash, Role)
                          VALUES (@FullName, @Email, @PhoneNo, @PasswordHash, @Role)";
                    }
                    else
                    {
                        query = @"INSERT INTO Users (FullName, Email, Gender, PhoneNo, Address, IDProofType, IDProofNumber, Occupation, PasswordHash, Role)
                          VALUES (@FullName, @Email, @Gender, @PhoneNo, @Address, @IDProofType, @IDProofNumber, @Occupation, @PasswordHash, @Role)";
                    }
                    SqlCommand cmd = new SqlCommand(query, con);
                    cmd.Parameters.AddWithValue("@FullName", user.FullName);
                    cmd.Parameters.AddWithValue("@Email", user.Email);
                    cmd.Parameters.AddWithValue("@PhoneNo", user.PhoneNo);
                    cmd.Parameters.AddWithValue("@PasswordHash", user.Password);
                    cmd.Parameters.AddWithValue("@Role", Role);

                    // Add extra fields for Users only
                    if (Role == "User")
                    {
                        cmd.Parameters.AddWithValue("@Gender", (object)user.Gender ?? DBNull.Value);
                        cmd.Parameters.AddWithValue("@Address", user.Address ?? "");
                        cmd.Parameters.AddWithValue("@IDProofType", user.IDProofType ?? "");
                        cmd.Parameters.AddWithValue("@IDProofNumber", user.IDProofNumber ?? "");
                        cmd.Parameters.AddWithValue("@Occupation", user.Occupation ?? "");
                    }
                    con.Open();
                    cmd.ExecuteNonQuery();
                }

                TempData["success"] = "Registered Successfully!";
                return RedirectToAction("Login");
            }
            catch (Exception ex)
            {
                TempData["error"] = "Registration failed: " + ex.Message;
                return View(user);
            }
        }
        // ===================== LOGIN ======================

        [HttpGet]
        public ActionResult Login()
        {
            return RedirectToAction("Index", "Home", new { openLogin = "true" });
        }

        [HttpPost]
        public ActionResult Login(string email, string password)
        {
            try
            {
                using (SqlConnection con = new SqlConnection(connString))
                {
                    con.Open();

                    // Check Admin
                    string adminQuery = @"SELECT AdminID AS ID, FullName, 'Admin' AS Role 
                                  FROM Admins 
                                  WHERE Email=@Email AND PasswordHash=@Password";

                    using (SqlCommand adminCmd = new SqlCommand(adminQuery, con))
                    {
                        adminCmd.Parameters.Add(new SqlParameter("@Email", SqlDbType.VarChar) { Value = email });
                        adminCmd.Parameters.Add(new SqlParameter("@Password", SqlDbType.VarChar) { Value = password });

                        using (SqlDataReader dr = adminCmd.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                Session["UserID"] = dr["ID"].ToString();
                                Session["AdminID"] = dr["ID"].ToString();
                                Session["FullName"] = dr["FullName"].ToString();
                                Session["Role"] = dr["Role"].ToString();

                                TempData["success"] = "Admin Login Successful!";
                                return RedirectToAction("Dashboard", "Admin");
                            }
                        }
                    }

                    // Check User
                    string userQuery = @"SELECT UserID AS ID, FullName, 'User' AS Role 
                                 FROM Users 
                                 WHERE Email=@Email AND PasswordHash=@Password";

                    using (SqlCommand userCmd = new SqlCommand(userQuery, con))
                    {
                        userCmd.Parameters.Add(new SqlParameter("@Email", SqlDbType.VarChar) { Value = email });
                        userCmd.Parameters.Add(new SqlParameter("@Password", SqlDbType.VarChar) { Value = password });

                        using (SqlDataReader dr = userCmd.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                Session["UserID"] = dr["ID"].ToString();
                                Session["FullName"] = dr["FullName"].ToString();
                                Session["Role"] = dr["Role"].ToString();

                                TempData["success"] = "Login Successful!";
                                return RedirectToAction("Index", "Home");
                            }
                        }
                    }

                    TempData["error"] = "Invalid Email or Password!";
                    return View();
                }
            }
            catch (Exception ex)
            {
                TempData["error"] = "Login error: " + ex.Message;
                return View();
            }
        }


        // ===================== LOGOUT ======================
        public ActionResult Logout()
        {
            Session.Clear();
            Session.Abandon();
            TempData["success"] = "Logged out successfully!";
            return RedirectToAction("Login");
        }

        [HttpGet]
        public ActionResult VerifyOTP(string Email)
        {
            ViewBag.Email = Email;
            return View();
        }

        [HttpGet]
        public ActionResult ResetPassword(string Email)
        {
            ViewBag.Email = Email;
            return View();
        }

        // ===================== ======================
        [HttpGet]
        public ActionResult ForgotPassword()
        {
            return View();
        }

        [HttpPost]
        public ActionResult SendOTP(string Email)
        {
            string otp = new Random().Next(100000, 999999).ToString();

            // STEP 1: CHECK EMAIL EXISTS
            using (SqlConnection con = new SqlConnection(connString))
            {
                SqlCommand cmd = new SqlCommand("SP_ForgotPassword", con);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.AddWithValue("@Mode", "CheckEmail");
                cmd.Parameters.AddWithValue("@Email", Email);

                con.Open();
                int count = Convert.ToInt32(cmd.ExecuteScalar());
                if (count == 0)
                {
                    TempData["error"] = "Email not found!";
                    return View("ForgotPassword");
                }
            }

            // STEP 2: SAVE OTP
            using (SqlConnection con = new SqlConnection(connString))
            {
                SqlCommand cmd = new SqlCommand("SP_ForgotPassword", con);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.AddWithValue("@Mode", "InsertOTP");
                cmd.Parameters.AddWithValue("@Email", Email);
                cmd.Parameters.AddWithValue("@OTP", otp);

                con.Open();
                cmd.ExecuteNonQuery();
            }

            // STEP 3: SEND OTP EMAIL
            SendOTPEmail(Email, otp);

            TempData["success"] = $"OTP Sent to {Email}";
            ViewBag.Email = Email;
            return View("VerifyOTP");
        }

        [HttpPost]
        public ActionResult VerifyOTP(string Email, string OTP)
        {
            using (SqlConnection con = new SqlConnection(connString))
            {
                SqlCommand cmd = new SqlCommand("SP_ForgotPassword", con);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.AddWithValue("@Mode", "VerifyOTP");
                cmd.Parameters.AddWithValue("@Email", Email);
                cmd.Parameters.AddWithValue("@OTP", OTP);

                con.Open();
                int valid = Convert.ToInt32(cmd.ExecuteScalar());

                if (valid == 1)
                {
                    TempData["success"] = "OTP Verified!";
                    ViewBag.Email = Email;
                    return View("ResetPassword");
                }
                else
                {
                    TempData["error"] = "Invalid OTP!";
                    ViewBag.Email = Email;
                    return View("VerifyOTP");
                }
            }
        }

        [HttpPost]
        public ActionResult ResetPassword(string Email, string NewPassword, string ConfirmPassword)
        {
            if (NewPassword != ConfirmPassword)
            {
                TempData["error"] = "Password mismatch!";
                ViewBag.Email = Email;
                return View();
            }

            using (SqlConnection con = new SqlConnection(connString))
            {
                SqlCommand cmd = new SqlCommand("SP_ForgotPassword", con);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.AddWithValue("@Mode", "UpdatePassword");
                cmd.Parameters.AddWithValue("@Email", Email);
                cmd.Parameters.AddWithValue("@NewPassword", NewPassword);

                con.Open();
                cmd.ExecuteNonQuery();
            }

            TempData["success"] = "Password Updated Successfully!";
            return RedirectToAction("Login");
        }

        // ===================== EMAIL FUNCTION ======================
        private void SendOTPEmail(string Email, string OTP)
        {
            try
            {
                MailMessage mail = new MailMessage();
                mail.To.Add(Email);
                mail.From = new MailAddress("your-email@gmail.com"); // Replace with your email
                mail.Subject = "Password Reset OTP";
                mail.Body = "Your OTP is: " + OTP;
                mail.IsBodyHtml = false;

                SmtpClient smtp = new SmtpClient("smtp.gmail.com", 587);
                smtp.Credentials = new NetworkCredential("your-email@gmail.com", "your-app-password"); // Use Gmail App Password
                smtp.EnableSsl = true;
                smtp.Send(mail);
            }
            catch (Exception ex)
            {
                TempData["error"] = "Error sending email: " + ex.Message;
            }
        }
    }
}
















CREATE PROCEDURE SP_ForgotPassword
    @Mode VARCHAR(20),
    @Email VARCHAR(200) = NULL,
    @OTP VARCHAR(10) = NULL,
    @NewPassword VARCHAR(200) = NULL
AS
BEGIN
    IF @Mode = 'CheckEmail'
    BEGIN
        SELECT COUNT(*) FROM Users WHERE Email = @Email;
        RETURN;
    END

    IF @Mode = 'InsertOTP'
    BEGIN
        DELETE FROM OTPTable WHERE Email = @Email;

        INSERT INTO OTPTable (Email, OTP, Expiry)
        VALUES (@Email, @OTP, DATEADD(MINUTE, 10, GETDATE()));
    END

    IF @Mode = 'VerifyOTP'
    BEGIN
        SELECT COUNT(*)
        FROM OTPTable
        WHERE Email = @Email
        AND OTP = @OTP
        AND Expiry > GETDATE();
    END

    IF @Mode = 'UpdatePassword'
    BEGIN
        UPDATE Users
        SET PasswordHash = @NewPassword
        WHERE Email = @Email;

        DELETE FROM OTPTable WHERE Email = @Email;
    END
END








using System.Net.Mail;
using System.Net;

public class AccountController : Controller
{
    string connString = ConfigurationManager.ConnectionStrings["EasyPG"].ConnectionString;

    // ===================== FORGOT PASSWORD ======================
    [HttpGet]
    public ActionResult ForgotPassword()
    {
        return View();
    }

    [HttpPost]
    public ActionResult SendOTP(string Email)
    {
        string otp = new Random().Next(100000, 999999).ToString();

        // STEP 1: CHECK EMAIL EXISTS
        using (SqlConnection con = new SqlConnection(connString))
        {
            SqlCommand cmd = new SqlCommand("SP_ForgotPassword", con);
            cmd.CommandType = CommandType.StoredProcedure;
            cmd.Parameters.AddWithValue("@Mode", "CheckEmail");
            cmd.Parameters.AddWithValue("@Email", Email);

            con.Open();
            int count = Convert.ToInt32(cmd.ExecuteScalar());
            if (count == 0)
            {
                TempData["error"] = "Email not found!";
                return View("ForgotPassword");
            }
        }

        // STEP 2: SAVE OTP
        using (SqlConnection con = new SqlConnection(connString))
        {
            SqlCommand cmd = new SqlCommand("SP_ForgotPassword", con);
            cmd.CommandType = CommandType.StoredProcedure;
            cmd.Parameters.AddWithValue("@Mode", "InsertOTP");
            cmd.Parameters.AddWithValue("@Email", Email);
            cmd.Parameters.AddWithValue("@OTP", otp);

            con.Open();
            cmd.ExecuteNonQuery();
        }

        // STEP 3: SEND OTP EMAIL
        SendOTPEmail(Email, otp);

        TempData["success"] = $"OTP Sent to {Email}";
        ViewBag.Email = Email;
        return View("VerifyOTP");
    }

    [HttpPost]
    public ActionResult VerifyOTP(string Email, string OTP)
    {
        using (SqlConnection con = new SqlConnection(connString))
        {
            SqlCommand cmd = new SqlCommand("SP_ForgotPassword", con);
            cmd.CommandType = CommandType.StoredProcedure;
            cmd.Parameters.AddWithValue("@Mode", "VerifyOTP");
            cmd.Parameters.AddWithValue("@Email", Email);
            cmd.Parameters.AddWithValue("@OTP", OTP);

            con.Open();
            int valid = Convert.ToInt32(cmd.ExecuteScalar());

            if (valid == 1)
            {
                TempData["success"] = "OTP Verified!";
                ViewBag.Email = Email;
                return View("ResetPassword");
            }
            else
            {
                TempData["error"] = "Invalid OTP!";
                ViewBag.Email = Email;
                return View("VerifyOTP");
            }
        }
    }

    [HttpPost]
    public ActionResult ResetPassword(string Email, string NewPassword, string ConfirmPassword)
    {
        if (NewPassword != ConfirmPassword)
        {
            TempData["error"] = "Password mismatch!";
            ViewBag.Email = Email;
            return View();
        }

        using (SqlConnection con = new SqlConnection(connString))
        {
            SqlCommand cmd = new SqlCommand("SP_ForgotPassword", con);
            cmd.CommandType = CommandType.StoredProcedure;
            cmd.Parameters.AddWithValue("@Mode", "UpdatePassword");
            cmd.Parameters.AddWithValue("@Email", Email);
            cmd.Parameters.AddWithValue("@NewPassword", NewPassword);

            con.Open();
            cmd.ExecuteNonQuery();
        }

        TempData["success"] = "Password Updated Successfully!";
        return RedirectToAction("Login");
    }

    // ===================== EMAIL FUNCTION ======================
    private void SendOTPEmail(string Email, string OTP)
    {
        try
        {
            MailMessage mail = new MailMessage();
            mail.To.Add(Email);
            mail.From = new MailAddress("your-email@gmail.com"); // Replace with your email
            mail.Subject = "Password Reset OTP";
            mail.Body = "Your OTP is: " + OTP;
            mail.IsBodyHtml = false;

            SmtpClient smtp = new SmtpClient("smtp.gmail.com", 587);
            smtp.Credentials = new NetworkCredential("your-email@gmail.com", "your-app-password"); // Use Gmail App Password
            smtp.EnableSsl = true;
            smtp.Send(mail);
        }
        catch (Exception ex)
        {
            TempData["error"] = "Error sending email: " + ex.Message;
        }
    }
}





[HttpPost]
public ActionResult SendOTP(string Email)
{
    string otp = new Random().Next(100000, 999999).ToString();

    // Check email exists
    using (SqlConnection con = new SqlConnection(connString))
    {
        SqlCommand cmd = new SqlCommand("SP_ForgotPassword", con);
        cmd.CommandType = CommandType.StoredProcedure;
        cmd.Parameters.AddWithValue("@Mode", "CheckEmail");
        cmd.Parameters.AddWithValue("@Email", Email);

        con.Open();
        int count = Convert.ToInt32(cmd.ExecuteScalar());

        if (count == 0)
        {
            TempData["error"] = "Email not found!";
            return View("ForgotPassword");
        }
    }

    // Insert OTP
    using (SqlConnection con = new SqlConnection(connString))
    {
        SqlCommand cmd = new SqlCommand("SP_ForgotPassword", con);
        cmd.CommandType = CommandType.StoredProcedure;
        cmd.Parameters.AddWithValue("@Mode", "InsertOTP");
        cmd.Parameters.AddWithValue("@Email", Email);
        cmd.Parameters.AddWithValue("@OTP", otp);

        con.Open();
        cmd.ExecuteNonQuery();
    }

    TempData["success"] = $"OTP Sent! (Debug OTP: {otp})";

    // Show OTP input on same page
    ViewBag.Email = Email;
    ViewBag.ShowOTP = true;

    return View("ForgotPassword");
}



[HttpPost]
public ActionResult VerifyOTP(string Email, string OTP)
{
    using (SqlConnection con = new SqlConnection(connString))
    {
        SqlCommand cmd = new SqlCommand("SP_ForgotPassword", con);
        cmd.CommandType = CommandType.StoredProcedure;

        cmd.Parameters.AddWithValue("@Mode", "VerifyOTP");
        cmd.Parameters.AddWithValue("@Email", Email);
        cmd.Parameters.AddWithValue("@OTP", OTP);

        con.Open();
        int valid = Convert.ToInt32(cmd.ExecuteScalar());

        if (valid == 1)
        {
            TempData["success"] = "OTP Verified!";
            return RedirectToAction("ResetPassword", new { email = Email });
        }
        else
        {
            TempData["error"] = "Invalid OTP!";
            ViewBag.Email = Email;
            ViewBag.ShowOTP = true;
            return View("ForgotPassword");
        }
    }
}









@{
    ViewBag.Title = "Forgot Password";
}

<h2 class="text-center mt-3">Forgot Password</h2>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-5">

            @if (TempData["error"] != null)
            {
                <div class="alert alert-danger">@TempData["error"]</div>
            }

            @if (TempData["success"] != null)
            {
                <div class="alert alert-success">@TempData["success"]</div>
            }

            <!-- If OTP is NOT sent yet => Show Email -->
            @if (ViewBag.ShowOTP == null)
            {
                <form method="post" action="/Account/SendOTP">
                    <div class="mb-3">
                        <label>Email</label>
                        <input type="email" name="Email" class="form-control" required />
                    </div>

                    <button class="btn btn-primary w-100 mt-3">Send OTP</button>
                </form>
            }

            <!-- If OTP is sent => Show OTP Box -->
            @if (ViewBag.ShowOTP == true)
            {
                <form method="post" action="/Account/VerifyOTP">
                    <input type="hidden" name="Email" value="@ViewBag.Email" />

                    <div class="mb-3">
                        <label>Enter OTP</label>
                        <input type="text" name="OTP" class="form-control" required />
                    </div>

                    <button class="btn btn-success w-100 mt-3">Verify OTP</button>
                </form>
            }
        </div>
    </div>
</div>



@{
    ViewBag.Title = "Reset Password";
}

<h2 class="text-center mt-3">Reset Your Password</h2>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-5">

            @if (TempData["success"] != null)
            {
                <div class="alert alert-success">@TempData["success"]</div>
            }
            @if (TempData["error"] != null)
            {
                <div class="alert alert-danger">@TempData["error"]</div>
            }

            <form method="post" action="/Account/ResetPassword">

                <!-- Hidden Email -->
                <input type="hidden" name="Email" value="@ViewBag.Email" />

                <!-- New Password -->
                <div class="mb-3">
                    <label class="form-label">New Password</label>
                    <input type="password" name="NewPassword" class="form-control" required />
                </div>

                <!-- Confirm Password -->
                <div class="mb-3">
                    <label class="form-label">Confirm New Password</label>
                    <input type="password" name="ConfirmPassword" class="form-control" required />
                </div>

                <button class="btn btn-primary w-100 mt-3">Reset Password</button>

                <div class="text-center mt-3">
                    <a href="/Account/Login">Back to Login</a>
                </div>

            </form>

        </div>
    </div>
</div>










using StayEasePG.Models;
using System;
using System.Collections.Generic;
using System.Configuration;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using System.Web;
using System.Web.Mvc;


namespace StayEasePG.Controllers
{
    public class AccountController : Controller
    {
        // DB Connection
        string connString = ConfigurationManager.ConnectionStrings["StayEasePGConn"].ConnectionString;


        // ===================== REGISTER ======================
        [HttpGet]
        public ActionResult Register()
        {
            return View();
        }

        [HttpPost]
        public ActionResult Register(UserModel user, string Role)
        {
            if (!ModelState.IsValid)
            {
                TempData["error"] = "Please fill all required fields correctly!";
                return View(user);
            }

            if (user.Password != user.ConfirmPassword)
            {
                TempData["error"] = "Passwords do not match!";
                return View(user);
            }

            try
            {
                using (SqlConnection con = new SqlConnection(connString))
                {
                    string query = "";

                    if (Role.Equals("Admin", StringComparison.OrdinalIgnoreCase))
                    {
                        query = @"INSERT INTO Admins (FullName, Email, PhoneNo, PasswordHash, Role)
                          VALUES (@FullName, @Email, @PhoneNo, @PasswordHash, @Role)";
                    }
                    else
                    {
                        query = @"INSERT INTO Users (FullName, Email, Gender, PhoneNo, Address, IDProofType, IDProofNumber, Occupation, PasswordHash, Role)
                          VALUES (@FullName, @Email, @Gender, @PhoneNo, @Address, @IDProofType, @IDProofNumber, @Occupation, @PasswordHash, @Role)";
                    }
                    SqlCommand cmd = new SqlCommand(query, con);
                    cmd.Parameters.AddWithValue("@FullName", user.FullName);
                    cmd.Parameters.AddWithValue("@Email", user.Email);
                    cmd.Parameters.AddWithValue("@PhoneNo", user.PhoneNo);
                    cmd.Parameters.AddWithValue("@PasswordHash", user.Password);
                    cmd.Parameters.AddWithValue("@Role", Role);

                    // Add extra fields for Users only
                    if (Role == "User")
                    {
                        cmd.Parameters.AddWithValue("@Gender", (object)user.Gender ?? DBNull.Value);
                        cmd.Parameters.AddWithValue("@Address", user.Address ?? "");
                        cmd.Parameters.AddWithValue("@IDProofType", user.IDProofType ?? "");
                        cmd.Parameters.AddWithValue("@IDProofNumber", user.IDProofNumber ?? "");
                        cmd.Parameters.AddWithValue("@Occupation", user.Occupation ?? "");
                    }
                    con.Open();
                    cmd.ExecuteNonQuery();
                }

                TempData["success"] = "Registered Successfully!";
                return RedirectToAction("Login");
            }
            catch (Exception ex)
            {
                TempData["error"] = "Registration failed: " + ex.Message;
                return View(user);
            }
        }
        // ===================== LOGIN ======================

        [HttpGet]
        public ActionResult Login()
        {
            return RedirectToAction("Index", "Home", new { openLogin = "true" });
        }

        [HttpPost]
        public ActionResult Login(string email, string password)
        {
            try
            {
                using (SqlConnection con = new SqlConnection(connString))
                {
                    con.Open();

                    // Check Admin
                    string adminQuery = @"SELECT AdminID AS ID, FullName, 'Admin' AS Role 
                                  FROM Admins 
                                  WHERE Email=@Email AND PasswordHash=@Password";

                    using (SqlCommand adminCmd = new SqlCommand(adminQuery, con))
                    {
                        adminCmd.Parameters.Add(new SqlParameter("@Email", SqlDbType.VarChar) { Value = email });
                        adminCmd.Parameters.Add(new SqlParameter("@Password", SqlDbType.VarChar) { Value = password });

                        using (SqlDataReader dr = adminCmd.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                Session["UserID"] = dr["ID"].ToString();
                                Session["AdminID"] = dr["ID"].ToString();
                                Session["FullName"] = dr["FullName"].ToString();
                                Session["Role"] = dr["Role"].ToString();

                                TempData["success"] = "Admin Login Successful!";
                                return RedirectToAction("Dashboard", "Admin");
                            }
                        }
                    }

                    // Check User
                    string userQuery = @"SELECT UserID AS ID, FullName, 'User' AS Role 
                                 FROM Users 
                                 WHERE Email=@Email AND PasswordHash=@Password";

                    using (SqlCommand userCmd = new SqlCommand(userQuery, con))
                    {
                        userCmd.Parameters.Add(new SqlParameter("@Email", SqlDbType.VarChar) { Value = email });
                        userCmd.Parameters.Add(new SqlParameter("@Password", SqlDbType.VarChar) { Value = password });

                        using (SqlDataReader dr = userCmd.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                Session["UserID"] = dr["ID"].ToString();
                                Session["FullName"] = dr["FullName"].ToString();
                                Session["Role"] = dr["Role"].ToString();

                                TempData["success"] = "Login Successful!";
                                return RedirectToAction("Index", "Home");
                            }
                        }
                    }

                    TempData["error"] = "Invalid Email or Password!";
                    return View();
                }
            }
            catch (Exception ex)
            {
                TempData["error"] = "Login error: " + ex.Message;
                return View();
            }
        }


        // ===================== LOGOUT ======================
        public ActionResult Logout()
        {
            Session.Clear();
            Session.Abandon();
            TempData["success"] = "Logged out successfully!";
            return RedirectToAction("Login");
        }

        [HttpGet]
        public ActionResult VerifyOTP(string Email)
        {
            ViewBag.Email = Email;
            return View();
        }

        [HttpGet]
        public ActionResult ResetPassword(string Email)
        {
            ViewBag.Email = Email;
            return View();
        }

        // ===================== FORGOT PASSWORD ======================
        [HttpGet]
        public ActionResult ForgotPassword()
        {
            return View();
        }

        [HttpPost]
        public ActionResult SendOTP(string Email)
        {
            string otp = new Random().Next(100000, 999999).ToString();

            // STEP 1: CHECK EMAIL EXISTS
            using (SqlConnection con = new SqlConnection(connString))
            {
                SqlCommand cmd = new SqlCommand("SP_ForgotPassword", con);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.AddWithValue("@Mode", "CheckEmail");
                cmd.Parameters.AddWithValue("@Email", Email);

                con.Open();
                int count = Convert.ToInt32(cmd.ExecuteScalar());

                if (count == 0)
                {
                    TempData["error"] = "Email not found!";
                    return View("ForgotPassword");
                }
            }

            // STEP 2: SAVE OTP
            using (SqlConnection con = new SqlConnection(connString))
            {
                SqlCommand cmd = new SqlCommand("SP_ForgotPassword", con);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.AddWithValue("@Mode", "InsertOTP");
                cmd.Parameters.AddWithValue("@Email", Email);
                cmd.Parameters.AddWithValue("@OTP", otp);

                con.Open();
                cmd.ExecuteNonQuery();
            }

            // STEP 3: DUMMY EMAIL SENDING
            TempData["success"] = $"OTP Sent to {Email} (OTP: {otp})";

            ViewBag.Email = Email;
            return View("VerifyOTP");
        }






        [HttpPost]
        public ActionResult VerifyOTP(string Email, string OTP)
        {
            using (SqlConnection con = new SqlConnection(connString))
            {
                SqlCommand cmd = new SqlCommand("SP_ForgotPassword", con);
                cmd.CommandType = CommandType.StoredProcedure;

                cmd.Parameters.AddWithValue("@Mode", "VerifyOTP");
                cmd.Parameters.AddWithValue("@Email", Email);
                cmd.Parameters.AddWithValue("@OTP", OTP);

                con.Open();
                int valid = Convert.ToInt32(cmd.ExecuteScalar());

                if (valid == 1)
                {
                    TempData["success"] = "OTP Verified!";
                    ViewBag.Email = Email;
                    return View("ResetPassword");
                }
                else
                {
                    TempData["error"] = "Invalid OTP!";
                    ViewBag.Email = Email;
                    return View("VerifyOTP");
                }
            }
        }






        [HttpPost]
        public ActionResult ResetPassword(string Email, string NewPassword, string ConfirmPassword)
        {
            if (NewPassword != ConfirmPassword)
            {
                TempData["error"] = "Password mismatch!";
                ViewBag.Email = Email;
                return View();
            }

            using (SqlConnection con = new SqlConnection(connString))
            {
                SqlCommand cmd = new SqlCommand("SP_ForgotPassword", con);
                cmd.CommandType = CommandType.StoredProcedure;

                cmd.Parameters.AddWithValue("@Mode", "UpdatePassword");
                cmd.Parameters.AddWithValue("@Email", Email);
                cmd.Parameters.AddWithValue("@NewPassword", NewPassword);

                con.Open();
                cmd.ExecuteNonQuery();
            }

            TempData["success"] = "Password Updated Successfully!";
            return RedirectToAction("Login");
        }
    }
}
