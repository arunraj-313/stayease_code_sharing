CREATE TABLE EmailOTP (
    ID INT IDENTITY(1,1) PRIMARY KEY,
    Email VARCHAR(150),
    OTP VARCHAR(10),
    CreatedOn DATETIME DEFAULT GETDATE()
);




CREATE PROCEDURE SP_CheckEmailExists
    @Email VARCHAR(150)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        (SELECT COUNT(*) FROM Users WHERE LOWER(Email)=LOWER(@Email)) +
        (SELECT COUNT(*) FROM Admins WHERE LOWER(Email)=LOWER(@Email)) AS EmailExists;
END





CREATE PROCEDURE SP_OTP
    @Mode VARCHAR(20),
    @Email VARCHAR(150),
    @OTP VARCHAR(10) = NULL
AS
BEGIN
    SET NOCOUNT ON;

    IF(@Mode='Insert')
    BEGIN
        INSERT INTO EmailOTP (Email, OTP) VALUES (@Email, @OTP);
    END

    IF(@Mode='Verify')
    BEGIN
        SELECT COUNT(*) 
        FROM EmailOTP 
        WHERE Email=@Email AND OTP=@OTP 
          AND DATEDIFF(MINUTE, CreatedOn, GETDATE()) <= 10;
    END
END





[HttpPost]
public ActionResult Register(UserModel user, string Role)
{
    user.Email = user.Email.ToLower().Trim();  // very important

    // check required fields
    if (!ModelState.IsValid)
    {
        TempData["error"] = "Please fill all required fields correctly!";
        return View(user);
    }

    if (user.Password != user.ConfirmPassword)
    {
        TempData["error"] = "Passwords do not match!";
        return View(user);
    }

    using (SqlConnection con = new SqlConnection(connString))
    {
        con.Open();

        // Step 1: Check email exists
        SqlCommand checkCmd = new SqlCommand("SP_CheckEmailExists", con);
        checkCmd.CommandType = CommandType.StoredProcedure;
        checkCmd.Parameters.AddWithValue("@Email", user.Email);

        int exists = Convert.ToInt32(checkCmd.ExecuteScalar());

        if (exists > 0)
        {
            TempData["error"] = "Email already exists!";
            return View(user);
        }
    }

    // STEP 2: Generate OTP
    string otp = new Random().Next(100000, 999999).ToString();

    using (SqlConnection con = new SqlConnection(connString))
    {
        con.Open();
        SqlCommand cmd = new SqlCommand("SP_OTP", con);
        cmd.CommandType = CommandType.StoredProcedure;
        cmd.Parameters.AddWithValue("@Mode", "Insert");
        cmd.Parameters.AddWithValue("@Email", user.Email);
        cmd.Parameters.AddWithValue("@OTP", otp);
        cmd.ExecuteNonQuery();
    }

    // STEP 3: Send Email
    SendOTPEmail(user.Email, otp);

    TempData["success"] = "OTP sent to your email!";
    TempData["UserData"] = user; // store temporarily
    TempData["Role"] = Role;

    ViewBag.Email = user.Email;
    return RedirectToAction("VerifyRegisterOTP", new { Email = user.Email });
}





[HttpGet]
public ActionResult VerifyRegisterOTP(string Email)
{
    ViewBag.Email = Email;
    return View();
}

[HttpPost]
public ActionResult VerifyRegisterOTP(string Email, string OTP)
{
    using (SqlConnection con = new SqlConnection(connString))
    {
        con.Open();
        SqlCommand cmd = new SqlCommand("SP_OTP", con);
        cmd.CommandType = CommandType.StoredProcedure;
        cmd.Parameters.AddWithValue("@Mode", "Verify");
        cmd.Parameters.AddWithValue("@Email", Email);
        cmd.Parameters.AddWithValue("@OTP", OTP);

        int valid = Convert.ToInt32(cmd.ExecuteScalar());

        if (valid == 0)
        {
            TempData["error"] = "Invalid OTP!";
            ViewBag.Email = Email;
            return View();
        }
    }

    // OTP correct â†’ complete registration
    return RedirectToAction("CompleteRegister", new { Email = Email });
}




public ActionResult CompleteRegister(string Email)
{
    var user = TempData["UserData"] as UserModel;
    string Role = TempData["Role"].ToString();

    if (user == null)
    {
        TempData["error"] = "Session expired. Please register again.";
        return RedirectToAction("Register");
    }

    using (SqlConnection con = new SqlConnection(connString))
    {
        con.Open();

        string query = "";

        if (Role == "Admin")
        {
            query = @"INSERT INTO Admins (FullName, Email, PhoneNo, PasswordHash, Role)
                      VALUES (@FullName, @Email, @PhoneNo, @PasswordHash, @Role)";
        }
        else
        {
            query = @"INSERT INTO Users (FullName, Email, Gender, PhoneNo, Address, IDProofType, IDProofNumber, Occupation, PasswordHash, Role)
                      VALUES (@FullName, @Email, @Gender, @PhoneNo, @Address, @IDProofType, @IDProofNumber, @Occupation, @PasswordHash, @Role)";
        }

        SqlCommand cmd = new SqlCommand(query, con);
        cmd.Parameters.AddWithValue("@FullName", user.FullName);
        cmd.Parameters.AddWithValue("@Email", user.Email);
        cmd.Parameters.AddWithValue("@PhoneNo", user.PhoneNo);
        cmd.Parameters.AddWithValue("@PasswordHash", user.Password);
        cmd.Parameters.AddWithValue("@Role", Role);

        if (Role == "User")
        {
            cmd.Parameters.AddWithValue("@Gender", user.Gender ?? "");
            cmd.Parameters.AddWithValue("@Address", user.Address ?? "");
            cmd.Parameters.AddWithValue("@IDProofType", user.IDProofType ?? "");
            cmd.Parameters.AddWithValue("@IDProofNumber", user.IDProofNumber ?? "");
            cmd.Parameters.AddWithValue("@Occupation", user.Occupation ?? "");
        }

        cmd.ExecuteNonQuery();
    }

    TempData["success"] = "Account created successfully!";
    TempData["OpenLoginPopup"] = "true";

    return RedirectToAction("Index", "Home");
}






private void SendOTPEmail(string Email, string OTP)
{
    try
    {
        MailMessage mail = new MailMessage();
        mail.To.Add(Email);
        mail.From = new MailAddress("stayeasepg@gmail.com");
        mail.Subject = "StayEase Registration OTP";
        mail.Body = $"Your OTP for StayEase registration is: {OTP}";
        mail.IsBodyHtml = false;

        SmtpClient smtp = new SmtpClient("smtp.gmail.com", 587);
        smtp.Credentials = new NetworkCredential("stayeasepg@gmail.com", "fstz tzcr yxbj bkbx");
        smtp.EnableSsl = true;

        smtp.Send(mail);
    }
    catch (Exception ex)
    {
        TempData["error"] = "Email error: " + ex.Message;
    }
}





@{
    ViewBag.Title = "Register";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2 class="text-center mt-3">Create Your Account</h2>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-6">

            @if (TempData["error"] != null)
            {
                <div class="alert alert-danger">@TempData["error"]</div>
            }
            @if (TempData["success"] != null)
            {
                <div class="alert alert-success">@TempData["success"]</div>
            }

            <form method="post" action="/Account/Register">

                <div class="mb-3">
                    <label>Full Name</label>
                    <input type="text" name="FullName" class="form-control" required />
                </div>

                <div class="mb-3">
                    <label>Email</label>
                    <input type="email" name="Email" class="form-control" required />
                </div>

                <div class="mb-3">
                    <label>Phone No</label>
                    <input type="text" name="PhoneNo" class="form-control" required />
                </div>

                <div class="mb-3">
                    <label>Gender</label>
                    <select name="Gender" class="form-control" required>
                        <option value="">Select Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Others">Others</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label>Address</label>
                    <input type="text" name="Address" class="form-control" required />
                </div>

                <div class="mb-3">
                    <label>ID Proof Type</label>
                    <select name="IDProofType" class="form-control" required>
                        <option value="">Select Proof</option>
                        <option value="Aadhar">Aadhar</option>
                        <option value="PAN">PAN</option>
                        <option value="Voter ID">Voter ID</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label>ID Proof Number</label>
                    <input type="text" name="IDProofNumber" class="form-control" required />
                </div>

                <div class="mb-3">
                    <label>Occupation</label>
                    <input type="text" name="Occupation" class="form-control" required />
                </div>

                <div class="mb-3">
                    <label>Password</label>
                    <input type="password" name="Password" class="form-control" required />
                </div>

                <div class="mb-3">
                    <label>Confirm Password</label>
                    <input type="password" name="ConfirmPassword" class="form-control" required />
                </div>

                <button class="btn btn-primary w-100 mt-3">Register</button>

                <div class="text-center mt-3">
                    <a href="#" onclick="openLoginPopup()">Already have an account? Login</a>
                </div>

            </form>
        </div>
    </div>
</div>







@{
    ViewBag.Title = "Verify OTP";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2 class="text-center mt-3">Verify OTP</h2>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-5">

            @if (TempData["error"] != null)
            {
                <div class="alert alert-danger">@TempData["error"]</div>
            }

            <form method="post" action="/Account/VerifyRegisterOTP">

                <input type="hidden" name="Email" value="@ViewBag.Email" />

                <div class="mb-3">
                    <label>Enter OTP</label>
                    <input type="text" name="OTP" class="form-control" required />
                </div>

                <button class="btn btn-success w-100 mt-3">Verify OTP</button>

            </form>

        </div>
    </div>
</div>








@{
    ViewBag.Title = "Complete Registration";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2 class="text-center mt-3">Complete Your Registration</h2>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-6">

            @if (TempData["error"] != null)
            {
                <div class="alert alert-danger">@TempData["error"]</div>
            }

            <form method="post" action="/Account/CompleteRegister">

                <input type="hidden" name="Email" value="@ViewBag.Email" />
                <input type="hidden" name="FullName" value="@ViewBag.FullName" />
                <input type="hidden" name="PhoneNo" value="@ViewBag.PhoneNo" />
                <input type="hidden" name="Gender" value="@ViewBag.Gender" />
                <input type="hidden" name="Address" value="@ViewBag.Address" />
                <input type="hidden" name="IDProofType" value="@ViewBag.IDProofType" />
                <input type="hidden" name="IDProofNumber" value="@ViewBag.IDProofNumber" />
                <input type="hidden" name="Occupation" value="@ViewBag.Occupation" />
                <input type="hidden" name="Password" value="@ViewBag.Password" />
                <input type="hidden" name="Role" value="User" />

                <div class="alert alert-info">
                    OTP verified successfully. Click "Finish" to complete registration.
                </div>

                <button class="btn btn-primary w-100 mt-3">Finish Registration</button>

            </form>

        </div>
    </div>
</div>
