             // 1️⃣ Email Validation
                string email = (user.Email ?? "").Trim();
                if (!email.Contains("@") || !email.Contains(".") || !email.EndsWith(".com"))
                {
                    TempData["error"] = "Invalid Email format. Example: name@gmail.com";
                    return View(user);
                }

                // 2️⃣ Phone Number Validation (Indian 10-digit)
                string phone = (user.PhoneNo ?? "").Trim();
                if (phone.Length != 10 || !phone.All(char.IsDigit) ||
                    !(phone.StartsWith("6") || phone.StartsWith("7") || phone.StartsWith("8") || phone.StartsWith("9")))
                {
                    TempData["error"] = "Invalid Phone number ";
                    return View(user);
                }

                // 3️⃣ ID Proof Validation
                string idType = (user.IDProofType ?? "").Trim();
                string idNumber = (user.IDProofNumber ?? "").Trim();

                if (idType == "Aadhaar")
                {
                    if (idNumber.Length != 12 || !idNumber.All(char.IsDigit))
                    {
                        TempData["error"] = "Aadhaar number must be 12 digits.";
                        return View(user);
                    }
                }
                else if (idType == "PAN")
                {
                    if (!Regex.IsMatch(idNumber, "^[A-Z]{5}[0-9]{4}[A-Z]$"))
                    {
                        TempData["error"] = "PAN number must be in format: ABCDE1234F";
                        return View(user);
                    }
                }

                // 4️⃣ Password Validation
                string pass = (user.Password ?? "").Trim();

                if (pass.Length < 6 || pass.Length > 12)
                {
                    TempData["error"] = "Password must be 6–12 characters.";
                    return View(user);
                }
                if (!pass.Any(char.IsUpper))
                {
                    TempData["error"] = "Password must contain at least 1 uppercase letter.";
                    return View(user);
                }
                if (!pass.Any(char.IsDigit))
                {
                    TempData["error"] = "Password must contain at least 1 number.";
                    return View(user);
                }
                if (!pass.Any(ch => "!@#$%^&*()".Contains(ch)))
                {
                    TempData["error"] = "Password must contain at least 1 special character.";
                    return View(user);
                }

                // ===================== VALIDATIONS END =====================

                // Your remaining code continues ↓↓↓

                // Normalize email and role
                string emailNormalized = email.ToLowerInvariant();
                string role = (user.Role ?? string.Empty).Trim();

                using (SqlConnection con = new SqlConnection(connString))
                {
                    con.Open();

                    // Count occurrences...
                    int userCount = 0, adminCount = 0;

                    using (SqlCommand cmdUsers = new SqlCommand("SELECT COUNT(*) FROM Users WHERE LOWER(Email) = @Email", con))
                    {
                        cmdUsers.Parameters.Add("@Email", SqlDbType.NVarChar, 256).Value = emailNormalized;
                        userCount = (int)cmdUsers.ExecuteScalar();
                    }
                    using (SqlCommand cmdAdmins = new SqlCommand("SELECT COUNT(*) FROM Admins WHERE LOWER(Email) = @Email", con))
                    {
                        cmdAdmins.Parameters.Add("@Email", SqlDbType.NVarChar, 256).Value = emailNormalized;
                        adminCount = (int)cmdAdmins.ExecuteScalar();
                    }

                    // Duplicate checks...
                    if (role.Equals("Admin", StringComparison.OrdinalIgnoreCase))
                    {
                        if (adminCount > 0)
                        {
                            TempData["error"] = "Email already exists in Admins!";
                            return View(user);
                        }
                    }
                    else
                    {
                        if (userCount > 0)
                        {
                            TempData["error"] = "Email already exists in Users!";
                            return View(user);
                        }
                    }
                }

                // OTP logic continues...
                Random rnd = new Random();
                int otp = rnd.Next(100000, 999999);

                // Save session & send OTP...
                // (rest of your code)

                return RedirectToAction("VerifyOTP");
            }
            catch (Exception ex)
            {
                TempData["error"] = "Something went wrong! " + ex.Message;
                return View(user);
            }
        }








[HttpPost]
        public ActionResult Register(UserModel user)
        {
            try
            {
                // Normalize email and role
                string emailNormalized = (user.Email ?? string.Empty).Trim().ToLowerInvariant();
                string role = (user.Role ?? string.Empty).Trim();

                using (SqlConnection con = new SqlConnection(connString))
                {
                    con.Open();

                    // Count occurrences in Users and Admins
                    int userCount = 0, adminCount = 0;
                    using (SqlCommand cmdUsers = new SqlCommand("SELECT COUNT(*) FROM Users WHERE LOWER(Email) = @Email", con))
                    {
                        cmdUsers.Parameters.Add("@Email", SqlDbType.NVarChar, 256).Value = emailNormalized;
                        userCount = (int)cmdUsers.ExecuteScalar();
                    }
                    using (SqlCommand cmdAdmins = new SqlCommand("SELECT COUNT(*) FROM Admins WHERE LOWER(Email) = @Email", con))
                    {
                        cmdAdmins.Parameters.Add("@Email", SqlDbType.NVarChar, 256).Value = emailNormalized;
                        adminCount = (int)cmdAdmins.ExecuteScalar();
                    }

                    // Role-based rules
                    if (role.Equals("Admin", StringComparison.OrdinalIgnoreCase))
                    {
                        if (adminCount > 0)
                        {
                            TempData["error"] = "Email already exists in Admins!";
                            return View(user);
                        }
                    }
                    else
                    {
                        if (userCount > 0)
                        {
                            TempData["error"] = "Email already exists in Users!";
                            return View(user);
                        }
                    }

                    if (userCount > 0 && adminCount > 0)
                    {
                        TempData["error"] = "Email has already been used.";
                        return View(user);
                    }
                }

                // Generate OTP
                Random rnd = new Random();
                int otp = rnd.Next(100000, 999999);

                // Save details in session
                Session["Reg_FullName"] = user.FullName;
                Session["Reg_Email"] = user.Email;
                Session["Reg_Password"] = user.Password;
                Session["Reg_Gender"] = user.Gender;
                Session["Reg_PhoneNo"] = user.PhoneNo;
                Session["Reg_Address"] = user.Address;
                Session["Reg_IDProofType"] = user.IDProofType;
                Session["Reg_IDProofNumber"] = user.IDProofNumber;
                Session["Reg_Occupation"] = user.Occupation;
                Session["Reg_Role"] = user.Role;
                Session["Reg_OTP"] = otp;

                // Send OTP
                bool mailStatus = SendOTPEmail(user.Email, otp);
                if (!mailStatus)
                {
                    TempData["error"] = "Failed to send OTP. Try again.";
                    return View(user);
                }

                return RedirectToAction("VerifyOTP");
            }
            catch (Exception ex)
            {
                TempData["error"] = "Something went wrong! " + ex.Message;
                return View(user);
            }
        }

        // -------------------- Send registration OTP --------------------
        public bool SendOTPEmail(string email, int otp)
        {
            try
            {
                MailMessage mail = new MailMessage();
                mail.To.Add(email);
                mail.From = new MailAddress("stayeasepgbooking@gmail.com");
                mail.Subject = "StayEase Registration OTP";
                mail.Body = $"Your OTP for StayEase registration is: {otp}";
                mail.IsBodyHtml = false;

                SmtpClient smtp = new SmtpClient("smtp.gmail.com", 587);
                smtp.EnableSsl = true;
                smtp.Credentials = new NetworkCredential("stayeasepgbooking@gmail.com", "fstz tzcr yxbj bkbx");
                smtp.Send(mail);

                return true;
            }
            catch
            {
                return false;
            }
        }

        [HttpGet]
        public ActionResult VerifyOTP()
        {
            return View();
        }

        [HttpPost]
        public ActionResult VerifyOTP(string otp)
        {
            if (Session["Reg_OTP"] == null)
            {
                TempData["error"] = "Session expired. Please register again.";
                return RedirectToAction("Register");
            }

            int sessionOTP = Convert.ToInt32(Session["Reg_OTP"]);
            if (!string.Equals(otp, sessionOTP.ToString(), StringComparison.Ordinal))
            {
                TempData["error"] = "Invalid OTP!";
                return View();
            }

            // Prepare user model and pass to CompleteRegister via TempData
            var user = new UserModel
            {
                FullName = Session["Reg_FullName"]?.ToString(),
                Email = Session["Reg_Email"]?.ToString(),
                Password = Session["Reg_Password"]?.ToString(),
                Gender = Session["Reg_Gender"]?.ToString(),
                PhoneNo = Session["Reg_PhoneNo"]?.ToString(),
                Address = Session["Reg_Address"]?.ToString(),
                IDProofType = Session["Reg_IDProofType"]?.ToString(),
                IDProofNumber = Session["Reg_IDProofNumber"]?.ToString(),
                Occupation = Session["Reg_Occupation"]?.ToString(),
                Role = Session["Reg_Role"]?.ToString()
            };

            TempData["UserData"] = user;
            TempData["Role"] = user.Role;
            Session.Remove("Reg_OTP");

            return RedirectToAction("CompleteRegister");
        }

        // ===================== COMPLETE REGISTER ======================
        public ActionResult CompleteRegister(string Email)
        {
            var user = TempData["UserData"] as UserModel;
            var role = (TempData["Role"] as string ?? "").Trim();

            if (user == null || string.IsNullOrWhiteSpace(role))
            {
                TempData["error"] = "Session expired. Please register again.";
                return RedirectToAction("Register");
            }

            string email = user.Email.Trim().ToLower();
            bool isAdmin = role.Equals("Admin", StringComparison.OrdinalIgnoreCase);

            try
            {
                using (SqlConnection con = new SqlConnection(connString))
                {
                    con.Open();

                    if (isAdmin)
                    {
                        // Insert in pending admin requests
                        string q = @"INSERT INTO PendingAdminRequests 
                             (FullName, Email, PhoneNo, PasswordHash) 
                             VALUES (@F,@E,@P,@PW)";
                        using (SqlCommand cmd = new SqlCommand(q, con))
                        {
                            cmd.Parameters.AddWithValue("@F", user.FullName);
                            cmd.Parameters.AddWithValue("@E", email);
                            cmd.Parameters.AddWithValue("@P", user.PhoneNo);
                            cmd.Parameters.AddWithValue("@PW", user.Password);
                            cmd.ExecuteNonQuery();
                        }

                        TempData["success"] = "Admin request submitted! Wait for approval.";
                    }
                    else
                    {
                        // Insert User
                        string q = @"INSERT INTO Users
                (FullName, Email, Gender, PhoneNo, Address, IDProofType, IDProofNumber,
                 Occupation, PasswordHash, Role)
                VALUES
                (@FullName,@Email,@Gender,@PhoneNo,@Address,@IDProofType,@IDProofNumber,
                 @Occupation,@PasswordHash,@Role)";

                        using (SqlCommand cmd = new SqlCommand(q, con))
                        {
                            cmd.Parameters.AddWithValue("@FullName", user.FullName);
                            cmd.Parameters.AddWithValue("@Email", email);
                            cmd.Parameters.AddWithValue("@Gender", user.Gender);
                            cmd.Parameters.AddWithValue("@PhoneNo", user.PhoneNo);
                            cmd.Parameters.AddWithValue("@Address", user.Address);
                            cmd.Parameters.AddWithValue("@IDProofType", user.IDProofType);
                            cmd.Parameters.AddWithValue("@IDProofNumber", user.IDProofNumber);
                            cmd.Parameters.AddWithValue("@Occupation", user.Occupation);
                            cmd.Parameters.AddWithValue("@PasswordHash", user.Password);
                            cmd.Parameters.AddWithValue("@Role", role);
                            cmd.ExecuteNonQuery();
                        }

                        // ⭐ SEND WELCOME EMAIL FOR USER NOW
                        SendWelcomeEmail(email, user.FullName);
                    }
                }

                Session.Clear();

                TempData["success"] = "Account created successfully!";
                TempData["OpenLoginPopup"] = "true";

                return RedirectToAction("Index", "Home", new { openLogin = "true" });
            }
            catch
            {
                TempData["error"] = "Something went wrong!";
                return RedirectToAction("Register");
            }
        }
